<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKE 재고관리 SYSTEM</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { 
            --erp-primary: #1e293b; --erp-accent: #3b82f6; --erp-bg: #f8fafc;
            --status-red: #ef4444;    /* 미입고 / 경고 */
            --status-brown: #9a3412;  /* 주의 (밤색) */
            --status-yellow: #eab308; /* 부족 / 부분입고 (노랑) */
            --status-green: #10b981;  /* 입고완료 / 양호 */
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--erp-bg); margin: 0; color: #1e293b; }
        .header { background: var(--erp-primary); display: flex; align-items: center; padding: 0 40px; height: 64px; position: sticky; top: 0; z-index: 2000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .logo { color: white; font-weight: 900; font-size: 20px; margin-right: 50px; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-weight: 700; font-size: 15px; padding: 0 25px; cursor: pointer; height: 100%; transition: 0.3s; }
        .nav-btn.active { color: white; background: rgba(255,255,255,0.1); box-shadow: inset 0 -4px 0 var(--erp-accent); }
        .container { max-width: 1650px; margin: 30px auto; padding: 0 30px; box-sizing: border-box; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .dash-container { display: flex; gap: 20px; overflow-x: auto; margin-bottom: 25px; padding: 5px; }
        .dash-card { min-width: 320px; background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; cursor: pointer; border-left: 6px solid var(--erp-accent); transition: 0.2s; }
        .dash-card:hover { transform: translateY(-3px); }
        .st-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .st-btn { border: none; padding: 10px; border-radius: 8px; font-weight: 800; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; color: white; }
        .input-section { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }
        input, select { padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; font-weight: 700; width: 100%; background: #fcfcfc; box-sizing: border-box; }
        .btn-erp { background: var(--erp-primary); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: 800; cursor: pointer; }
        .editable { cursor: pointer; font-weight: 700; transition: 0.2s; padding: 5px; border-radius: 4px; }
        .editable:hover { background: #f1f5f9; color: var(--erp-accent); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 800; display: inline-block; }
        .status-mi { background: #fee2e2; color: #991b1b; } 
        .status-part { background: #fef9c3; color: #854d0e; } 
        .status-ok { background: #dcfce7; color: #166534; } 
        .delay-tag { background: #dc2626; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 900; margin-right: 5px; }
        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; }
        th { background: #f8fafc; padding: 12px; color: #64748b; font-size: 12px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 600; }
        .gmail-btn { position: absolute; top: 15px; right: 15px; background: #ea4335; color: white; border: none; padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 900; cursor: pointer; }
        .del-btn { color: #ef4444; border: 1px solid #fee2e2; background: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 800; }
        .copy-btn { color: var(--erp-accent); border: 1px solid #e0f2fe; background: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 800; }
        .total-row { background-color: #f1f5f9; font-weight: 900; border-top: 2px solid #cbd5e1; }
        .erp-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-body { background: white; margin: 10% auto; padding: 30px; border-radius: 16px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>

<header class="header">
    <div class="logo">SKE 재고 SYSTEM</div>
    <div class="nav-group">
        <button id="nav-stock" class="nav-btn active" onclick="switchPage('stock')">통합 재고 관리</button>
        <button id="nav-materials" class="nav-btn" onclick="switchPage('materials')">사급 자재 현황</button>
    </div>
</header>

<div class="container">
    <div id="page-stock" class="page-content active">
        <div id="stock-dash" class="dash-container"></div>
        <div class="input-section">
            <div class="input-grid">
                <input type="date" id="st-date"><input type="text" id="st-code" placeholder="품목코드">
                <select id="st-parent"><option value="CABLE">CABLE</option><option value="SLEEVE">SLEEVE</option></select>
                <input type="text" id="st-item" placeholder="품목명"><input type="text" id="st-spec" placeholder="규격">
                <select id="st-type"><option value="입고">입고</option><option value="출고">출고</option></select>
                <input type="number" id="st-qty" value="0"><button class="btn-erp" onclick="addData('stock')">등록</button>
            </div>
        </div>
        <tbody id="stock-table-body"></tbody>
    </div>

    <div id="page-materials" class="page-content">
        <div id="ma-dash" class="dash-container"></div>
        <div class="input-section">
            <div class="input-grid">
                <input type="date" id="ma-date">
                <input type="text" id="ma-po" placeholder="발주번호(PO)">
                <input type="text" id="ma-project" placeholder="프로젝트">
                <input type="text" id="ma-vendor" placeholder="업체명">
                <input type="text" id="ma-item" placeholder="자재명">
                <input type="number" id="ma-req" placeholder="필요량">
                <input type="number" id="ma-recv" placeholder="입고량">
                <input type="text" id="ma-receiver" placeholder="수령인">
                <button class="btn-erp" onclick="addData('material')">등록</button>
            </div>
        </div>
        <table>
            <thead><tr><th>발주일</th><th>발주번호</th><th>프로젝트</th><th>업체</th><th>품명(이력)</th><th>수령인</th><th>필요</th><th>입고</th><th>상태</th><th>관리</th></tr></thead>
            <tbody id="ma-table-body"></tbody>
        </table>
    </div>
</div>

<div id="historyModal" class="erp-modal">
    <div class="modal-body">
        <span onclick="closeModal()" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <div id="modalTitle" style="font-weight:900; font-size:18px; margin-bottom:20px;"></div>
        <div id="history-content"></div>
    </div>
</div>

<script>
    const STOCK_URL = "https://ske-00003-default-rtdb.firebaseio.com/stock_management.json";
    const MATERIAL_URL = "https://ske-0001-default-rtdb.firebaseio.com/inventory.json";
    let db = { stock: [], material: [] };

    // 담당자 명단
    const VENDOR_CONTACTS = {
        "한주하이텍": { name: "석성용 과장님", email: "sysuk1@hanjoohitech.com" },
        "프로텍": { name: "노하경 과장님", email: "hknoh@protec21.co.kr" },
        "네비간티스": { name: "우한솔 프로님", email: "hanswoo@navigantis.co" }
    };

    async function loadStock() {
        const res = await fetch(STOCK_URL); db.stock = Object.values(await res.json() || {});
        renderStock();
    }
    async function loadMaterials() {
        const res = await fetch(MATERIAL_URL); db.material = Object.values(await res.json() || {});
        renderMaDash(); renderMaterials();
    }

    function renderMaterials() {
        const today = new Date();
        document.getElementById('ma-table-body').innerHTML = db.material.sort((a,b)=>b.timestamp-a.timestamp).map((m, idx) => {
            const req = m.targetQty || 0;
            const recv = m.history ? m.history.reduce((sum, h) => sum + Number(h.qty), 0) : (m.inQty || 0);
            const isDelay = (recv < req) && (today - new Date(m.regDate || m.date)) / 86400000 >= 7;
            const rIdx = db.material.indexOf(m);
            let badge = recv === 0 ? '<span class="badge status-mi">미입고</span>' : (recv < req ? '<span class="badge status-part">부분입고</span>' : '<span class="badge status-ok">입고완료</span>');
            
            return `<tr>
                <td>${m.regDate || m.date}</td>
                <td><span class="editable" onclick="editData('material', ${rIdx}, 'po')">${m.po || '-'}</span></td>
                <td>${m.project}</td>
                <td>${m.vendor}</td>
                <td style="text-align:left;"><span class="editable" onclick="openMaHistory(${rIdx})">${isDelay?'<span class="delay-tag">⚠️ 지연</span>':''}${m.item}</span></td>
                <td>${m.receiver || '-'}</td>
                <td>${req}</td>
                <td>${recv.toLocaleString()}</td>
                <td>${badge}</td>
                <td><button class="copy-btn" onclick="copyRow('material',null,null,null,null,${rIdx})">복사</button> <button class="del-btn" onclick="deleteData('material', ${m.timestamp})">삭제</button></td>
            </tr>`;
        }).join('');
    }

    function renderMaDash() {
        const vMap = {}; const today = new Date();
        db.material.forEach(m => {
            if(!vMap[m.vendor]) vMap[m.vendor] = { total: 0, ok: 0, delayed: [] };
            const req = m.targetQty || 0;
            const recv = m.history ? m.history.reduce((sum, h) => sum + Number(h.qty), 0) : (m.inQty || 0);
            vMap[m.vendor].total++; if(recv >= req) vMap[m.vendor].ok++;
            if(recv < req && (today - new Date(m.regDate || m.date)) / 86400000 >= 7) {
                // 발주번호를 포함하여 지연 목록에 저장
                vMap[m.vendor].delayed.push({ project: m.project, item: m.item, req, recv, po: m.po || "번호없음" });
            }
        });
        document.getElementById('ma-dash').innerHTML = Object.keys(vMap).map(v => {
            const per = Math.round((vMap[v].ok / vMap[v].total) * 100) || 0;
            return `<div class="dash-card">
                <span style="font-size:12px; color:#64748b; font-weight:800;">VENDOR</span>
                ${vMap[v].delayed.length > 0 ? `<button class="gmail-btn" onclick="sendGmailTable('${v}', ${JSON.stringify(vMap[v].delayed).replace(/"/g, '&quot;')})">Gmail 독촉</button>` : ''}
                <div style="font-size:18px; font-weight:900; margin:10px 0;">${v}</div>
                <div style="font-size:22px; font-weight:900;">${per}%</div>
            </div>`;
        }).join('');
    }

    // --- 수정한 Gmail 발송 함수 ---
    function sendGmailTable(v, l) { 
        event.stopPropagation(); 
        const contact = VENDOR_CONTACTS[v] || { name: "담당자님", email: "" };
        
        // 지연된 첫 번째 자재의 실제 발주번호를 기본 번호로 사용
        const poNumber = l[0].po; 

        let tableText = "--------------------------------------------------\n| 프로젝트 | 품목명 | 필요량 | 입고량 |\n--------------------------------------------------\n";
        l.forEach(r => { tableText += `| ${r.project} | ${r.item} | ${r.req} | ${r.recv} |\n`; });
        tableText += "--------------------------------------------------\n";

        const subject = encodeURIComponent(`[SKE ERP] 납기 지연 입고 요청 및 납기 확인 (발주번호: ${poNumber})`);
        const bodyContent = `안녕하십니까, ${v} ${contact.name}.\n\n` +
            `SKE 관리팀입니다.\n\n` +
            `귀사에서 진행 중인 발주건(${poNumber})과 관련하여 아래 자재들이 7일 이상 지연되고 있습니다.\n\n` +
            `${tableText}\n` +
            `공정 차질이 발생하지 않도록 조속한 입고와 납기 확인 부탁드립니다.\n\n` +
            `감사합니다.`;
        
        window.open(`https://mail.google.com/mail/?view=cm&fs=1&to=${contact.email}&su=${subject}&body=${encodeURIComponent(bodyContent)}`, '_blank'); 
    }

    async function addData(type) {
        const ts = Date.now();
        if(type === 'stock') {
            db.stock.push({ date: document.getElementById('st-date').value, code: document.getElementById('st-code').value, parent: document.getElementById('st-parent').value, item: document.getElementById('st-item').value, spec: document.getElementById('st-spec').value, type: document.getElementById('st-type').value, qty: Number(document.getElementById('st-qty').value), timestamp: ts });
        } else {
            const recvQty = Number(document.getElementById('ma-recv').value);
            db.material.push({ 
                regDate: document.getElementById('ma-date').value, 
                po: document.getElementById('ma-po').value, // 입력창의 발주번호 저장
                project: document.getElementById('ma-project').value, 
                vendor: document.getElementById('ma-vendor').value, 
                item: document.getElementById('ma-item').value, 
                targetQty: Number(document.getElementById('ma-req').value), 
                inQty: recvQty, 
                receiver: document.getElementById('ma-receiver').value, 
                timestamp: ts, 
                history: recvQty > 0 ? [{ date: document.getElementById('ma-date').value, qty: recvQty, memo: "최초등록", ts: ts }] : []
            });
        }
        await saveData(type);
    }

    async function saveData(type) { await fetch(type==='stock'?STOCK_URL:MATERIAL_URL, { method: 'PUT', body: JSON.stringify(db[type]) }); type==='stock'?loadStock():loadMaterials(); }
    async function editData(type, idx, field) { let v = prompt("수정:", db[type][idx][field]); if(v!==null){ db[type][idx][field]=v; await saveData(type); } }
    async function deleteData(type, ts) { if(confirm("삭제?")){ db[type]=db[type].filter(d=>d.timestamp!==ts); await saveData(type); } }
    function switchPage(p) { document.querySelectorAll('.page-content').forEach(x=>x.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); p==='stock'?loadStock():loadMaterials(); }
    
    // 나머지 UI 함수들...
    function openMaHistory(i) { /* ... */ }
    function closeModal() { document.getElementById('historyModal').style.display='none'; }
    function copyRow(t, n, s, p, c, i) { 
        if(t==='material') {
            const d = db.material[i];
            document.getElementById('ma-po').value = d.po || '';
            document.getElementById('ma-project').value = d.project;
            document.getElementById('ma-vendor').value = d.vendor;
            document.getElementById('ma-item').value = d.item;
            document.getElementById('ma-req').value = d.targetQty;
        }
    }

    document.querySelectorAll('input[type="date"]').forEach(i => i.value = new Date().toISOString().split('T')[0]);
    loadStock();
</script>
</body>
</html>
