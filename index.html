<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SKE Ïû¨Í≥†Í¥ÄÎ¶¨ SYSTEM</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        :root { 
            --erp-primary: #1e293b; --erp-accent: #3b82f6; --erp-bg: #f8fafc;
            --status-red: #ef4444; --status-brown: #9a3412; --status-yellow: #eab308; --status-green: #10b981;
        }
        body { font-family: 'Pretendard', sans-serif; background: var(--erp-bg); margin: 0; color: #1e293b; }
        .header { background: var(--erp-primary); display: flex; align-items: center; padding: 0 40px; height: 64px; position: sticky; top: 0; z-index: 2000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .logo { color: white; font-weight: 900; font-size: 20px; margin-right: 50px; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-weight: 700; font-size: 15px; padding: 0 25px; cursor: pointer; height: 100%; transition: 0.3s; }
        .nav-btn.active { color: white; background: rgba(255,255,255,0.1); box-shadow: inset 0 -4px 0 var(--erp-accent); }
        .container { max-width: 1650px; margin: 30px auto; padding: 0 30px; box-sizing: border-box; }
        .page-content { display: none; }
        .page-content.active { display: block; }
        
        .btn-erp { background: var(--erp-primary); color: white; border: none; padding: 10px 15px; border-radius: 6px; font-weight: 800; cursor: pointer; }
        .btn-order-main { background: #8b5cf6; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 900; cursor: pointer; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.2); }

        table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0; }
        th { background: #f8fafc; padding: 12px; color: #64748b; font-size: 12px; border-bottom: 1px solid #e2e8f0; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f5f9; font-size: 13px; font-weight: 600; }
        
        .editable { cursor: pointer; font-weight: 700; transition: 0.2s; padding: 5px; border-radius: 4px; }
        .editable:hover { background: #f1f5f9; color: var(--erp-accent); }
        
        .erp-modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-body { background: white; margin: 5% auto; padding: 30px; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        
        .item-list-table { width: 100%; margin-top: 15px; border: 1px solid #eee; }
        .item-list-table th { background: #f9fafb; font-size: 11px; }
        .item-list-table input { border: 1px solid #ddd; padding: 5px; width: 80%; text-align: center; }
    </style>
</head>
<body>

<header class="header">
    <div class="logo">SKE Ïû¨Í≥† SYSTEM</div>
    <div class="nav-group">
        <button id="nav-stock" class="nav-btn active" onclick="switchPage('stock')">ÌÜµÌï© Ïû¨Í≥† Í¥ÄÎ¶¨</button>
        <button id="nav-materials" class="nav-btn" onclick="switchPage('materials')">ÏÇ¨Í∏â ÏûêÏû¨ ÌòÑÌô©</button>
    </div>
</header>

<div class="container">
    <div id="page-stock" class="page-content active">
        <div id="stock-dash" class="dash-container"></div>
        <div style="display:flex; justify-content: space-between; align-items: flex-end;">
            <div style="margin-bottom:10px;">
                <input type="text" id="st-search" oninput="renderStock()" style="width:300px; padding:10px; border-radius:8px; border:1px solid #ddd;" placeholder="üîç Search Items...">
            </div>
            <button class="btn-order-main" onclick="openMultiOrderModal()">üì¶ ÏÑ†ÌÉù ÌíàÎ™© Î∞úÏ£ºÏÑú ÏûëÏÑ± (Bulk Order)</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="40"><input type="checkbox" id="check-all" onclick="toggleAllChecks(this)"></th>
                    <th>ÏΩîÎìú</th><th>Î∂ÑÎ•ò</th><th>ÌíàÎ™©Î™Ö</th><th>Í∑úÍ≤©</th><th>ÌòÑÏû¨Ïû¨Í≥†(History)</th><th>ÏÉÅÌÉú</th><th>Í¥ÄÎ¶¨</th>
                </tr>
            </thead>
            <tbody id="stock-table-body"></tbody>
        </table>
    </div>
    
    <div id="page-materials" class="page-content">
        <div id="ma-table-container">
            </div>
    </div>
</div>

<div id="multiOrderModal" class="erp-modal">
    <div class="modal-body">
        <span onclick="closeOrderModal()" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <div style="font-weight:900; font-size:20px; margin-bottom:10px; color: #8b5cf6;">üìÑ Create Bulk Purchase Order</div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <div>
                <label style="font-size:12px; font-weight:800;">Vendor (Í≥µÍ∏âÏóÖÏ≤¥)</label>
                <select id="bulk-vendor" style="width:100%; padding:8px;">
                    <option value="PROTEC">PROTEC (ÌîÑÎ°úÌÖç)</option>
                    <option value="HANJOO HITECH">HANJOO HITECH (ÌïúÏ£ºÌïòÏù¥ÌÖç)</option>
                    <option value="NAVIGANTIS">NAVIGANTIS (ÎÇ¥ÎπÑÍ∞ÑÌã∞Ïä§)</option>
                </select>
            </div>
            <div>
                <label style="font-size:12px; font-weight:800;">Delivery Date (Ìù¨ÎßùÎÇ©Í∏∞)</label>
                <input type="date" id="bulk-date" style="width:100%; padding:7px;">
            </div>
        </div>

        <table class="item-list-table">
            <thead>
                <tr>
                    <th>Description</th><th>Specification</th><th width="120">Quantity</th><th width="60">Del</th>
                </tr>
            </thead>
            <tbody id="bulk-order-items"></tbody>
        </table>
        
        <button class="btn-erp" style="width:100%; margin-top:25px; background:#8b5cf6; padding:15px; font-size:16px;" onclick="printBulkOrder()">Print English Purchase Order</button>
    </div>
</div>

<div id="historyModal" class="erp-modal">
    <div class="modal-body">
        <span onclick="closeModal()" style="float:right; cursor:pointer; font-size:28px;">&times;</span>
        <div id="modalTitle" style="font-weight:900; font-size:18px; margin-bottom:20px;"></div>
        <div id="history-content"></div>
    </div>
</div>

<script>
    const STOCK_URL = "https://ske-00003-default-rtdb.firebaseio.com/stock_management.json";
    let db = { stock: [] };

    async function loadStock() {
        const res = await fetch(STOCK_URL); 
        db.stock = Object.values(await res.json() || {});
        renderStock();
    }

    function renderStock() {
        const search = document.getElementById('st-search').value.toUpperCase();
        const sum = {};
        db.stock.forEach(d => {
            const k = `${d.item}|${d.spec}`;
            if(!sum[k]) sum[k] = { code: d.code || '-', name: d.item, spec: d.spec, q: 0, p: d.parent || 'CABLE' };
            sum[k].q += (d.type === 'Ï∂úÍ≥†' ? -Number(d.qty) : Number(d.qty));
        });

        const rows = Object.values(sum).filter(s => search === '' || `${s.code}${s.name}${s.spec}`.toUpperCase().includes(search));
        
        document.getElementById('stock-table-body').innerHTML = rows.map((s, idx) => {
            const lv = getLv(s.q, s.p);
            return `<tr>
                <td><input type="checkbox" class="order-chk" data-name="${s.name}" data-spec="${s.spec}"></td>
                <td>${s.code}</td>
                <td>${s.p}</td>
                <td><span class="editable" style="color:var(--erp-accent)" onclick="openSingleOrder('${s.name}','${s.spec}')">${s.name}</span></td>
                <td>${s.spec||'-'}</td>
                <td><span class="editable" onclick="openHistory('${s.name}','${s.spec}')">${s.q.toLocaleString()}</span></td>
                <td style="color:${lv.c};">‚óè ${lv.t}</td>
                <td><button class="copy-btn" onclick="copyRow()">Î≥µÏÇ¨</button></td>
            </tr>`;
        }).join('');
    }

    // Ï†ÑÏ†ú ÏÑ†ÌÉù ÌÜ†Í∏Ä
    function toggleAllChecks(master) {
        document.querySelectorAll('.order-chk').forEach(c => c.checked = master.checked);
    }

    // 1Í∞ú ÌíàÎ™©Îßå ÌÅ¥Î¶≠ÌñàÏùÑ ÎïåÎèÑ Î™®Îã¨ Ïó¥Î¶¨Í≤å Ï≤òÎ¶¨
    function openSingleOrder(name, spec) {
        // Î™®Îì† Ï≤¥ÌÅ¨ Ìï¥Ï†ú ÌõÑ Ìï¥Îãπ ÌíàÎ™©Îßå Ï≤¥ÌÅ¨
        document.querySelectorAll('.order-chk').forEach(c => c.checked = false);
        const target = Array.from(document.querySelectorAll('.order-chk')).find(c => c.dataset.name === name && c.dataset.spec === spec);
        if(target) target.checked = true;
        openMultiOrderModal();
    }

    // ÏÑ†ÌÉùÎêú ÌíàÎ™©Îì§ÏùÑ Î™®Îã¨ Î¶¨Ïä§Ìä∏Ïóê Îã¥Í∏∞
    function openMultiOrderModal() {
        const selected = Array.from(document.querySelectorAll('.order-chk:checked'));
        if(selected.length === 0) { alert("Î∞úÏ£ºÌï† ÌíàÎ™©ÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî."); return; }

        let html = '';
        selected.forEach((chk, idx) => {
            html += `
                <tr id="row-${idx}">
                    <td style="text-align:left; padding-left:10px;">${chk.dataset.name}</td>
                    <td>${chk.dataset.spec}</td>
                    <td><input type="number" class="bulk-qty" value="0"></td>
                    <td><button onclick="this.parentElement.parentElement.remove()" style="border:none; color:red; cursor:pointer;">&times;</button></td>
                </tr>`;
        });
        document.getElementById('bulk-order-items').innerHTML = html;
        document.getElementById('bulk-date').value = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0];
        document.getElementById('multiOrderModal').style.display = 'block';
    }

    function closeOrderModal() { document.getElementById('multiOrderModal').style.display = 'none'; }

    // ÏòÅÎ¨∏ Î∞úÏ£ºÏÑú(Îã§Ï§ë ÌíàÎ™©) Ï∂úÎ†•
    function printBulkOrder() {
        const vendor = document.getElementById('bulk-vendor').value;
        const dueDate = document.getElementById('bulk-date').value;
        const rows = document.querySelectorAll('#bulk-order-items tr');
        
        let itemRowsHtml = '';
        rows.forEach((row, idx) => {
            const cells = row.cells;
            const name = cells[0].innerText;
            const spec = cells[1].innerText;
            const qty = row.querySelector('.bulk-qty').value;
            itemRowsHtml += `
                <tr>
                    <td>${idx + 1}</td>
                    <td style="text-align:left;">${name}</td>
                    <td>${spec}</td>
                    <td>${Number(qty).toLocaleString()}</td>
                    <td>PCS</td>
                </tr>`;
        });

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
            <head>
                <style>
                    body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
                    .po-header { text-align: center; font-size: 32px; font-weight: bold; border-bottom: 3px solid #000; padding-bottom: 10px; margin-bottom: 30px; }
                    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    .info-table td { padding: 8px; border: 1px solid #ddd; font-size: 14px; }
                    .label { background: #f4f4f4; font-weight: bold; width: 140px; }
                    .main-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .main-table th { background: #000; color: #fff; padding: 12px; border: 1px solid #000; font-size: 13px; }
                    .main-table td { padding: 10px; border: 1px solid #000; text-align: center; font-size: 13px; }
                    .footer { margin-top: 50px; text-align: right; }
                    .sign { display: inline-block; border-top: 2px solid #000; width: 200px; margin-top: 40px; text-align: center; }
                </style>
            </head>
            <body>
                <div class="po-header">PURCHASE ORDER</div>
                <table class="info-table">
                    <tr>
                        <td class="label">P/O No.</td><td>SKE-PO-${Date.now().toString().slice(-8)}</td>
                        <td class="label">P/O Date</td><td>${new Date().toLocaleDateString('en-US')}</td>
                    </tr>
                    <tr>
                        <td class="label">Vendor (To)</td><td>${vendor}</td>
                        <td class="label">Buyer (From)</td><td>SKE CO., LTD.<br>Gyeonggi-do, Korea</td>
                    </tr>
                    <tr>
                        <td class="label">Delivery Due</td><td colspan="3">${dueDate}</td>
                    </tr>
                </table>
                <table class="main-table">
                    <thead>
                        <tr><th>No</th><th>Description / Item</th><th>Specification</th><th>Quantity</th><th>Unit</th></tr>
                    </thead>
                    <tbody>${itemRowsHtml}</tbody>
                </table>
                <div class="footer">
                    <p>SKE CO., LTD.</p>
                    <div class="sign">Authorized Signature</div>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // Í∏∞Ï°¥ Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
    function openHistory(n, s) { 
        const h = db.stock.filter(d => d.item === n && d.spec === s).sort((a,b)=>b.timestamp-a.timestamp); 
        document.getElementById('modalTitle').innerText = `üì¶ History: ${n}`; 
        document.getElementById('history-content').innerHTML = `<table><thead><tr><th>Date</th><th>Type</th><th>Qty</th></tr></thead><tbody>${h.map(x => `<tr><td>${x.date}</td><td>${x.type}</td><td>${x.qty}</td></tr>`).join('')}</tbody></table>`; 
        document.getElementById('historyModal').style.display = 'block'; 
    }
    function closeModal() { document.getElementById('historyModal').style.display = 'none'; }
    function getLv(q, p) {
        const limit = p === 'SLEEVE' ? [1000, 3000, 5000] : [3000, 5000, 10000];
        if(q < limit[0]) return { t: 'Critical', c: 'var(--status-red)' };
        if(q < limit[1]) return { t: 'Warning', c: 'var(--status-brown)' };
        if(q < limit[2]) return { t: 'Low', c: 'var(--status-yellow)' };
        return { t: 'Good', c: 'var(--status-green)' };
    }
    function switchPage(p) { document.querySelectorAll('.page-content').forEach(x => x.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active')); document.getElementById('page-' + p).classList.add('active'); document.getElementById('nav-' + p).classList.add('active'); if(p === 'stock') loadStock(); }
    
    loadStock();
</script>
</body>
</html>
